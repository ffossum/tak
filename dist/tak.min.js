(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports,require("lodash")):typeof define==="function"&&define.amd?define(["exports","lodash"],factory):factory(global.TAK=global.TAK||{},global._)})(this,function(exports,lodash){"use strict";var babelHelpers={};babelHelpers.toConsumableArray=function(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}else{return Array.from(arr)}};babelHelpers;var RANKS="abcdefgh";var WHITE="1";var BLACK="2";function getInitialState(size){return{activeColor:WHITE,moveNumber:1,board:createEmptyBoard(size)}}function createEmptyBoard(size){return lodash.times(size,function(){return createEmptyRank(size)})}function createEmptyRank(size){return lodash.times(size,function(){return[]})}function getCoords(ptnMove){var matches=ptnMove.match(/([a-h])([1-8])/);var rank=matches[2]-1;var file=RANKS.indexOf(matches[1]);return[rank,file]}function getState(state,ptnMoves){return lodash.reduce(lodash.concat(ptnMoves),nextState,state)}function nextState(state,ptnMove){var newState=lodash.cloneDeep(state);var coords=getCoords(ptnMove);if(isPlacement(ptnMove)){var type=ptnMove.match(/^[CS]?/)[0];lodash.set(newState.board,coords,[getPlacedColor(state)+type])}else{var stones=lodash.get(newState.board,coords);var movingStoneCount=Number(ptnMove.match(/^\d*/)[0]||1);var movingStones=lodash.takeRight(stones,movingStoneCount);var dropCounts=getDropCounts(ptnMove);var direction=getMovementDirection(ptnMove);liftStones(newState.board,movingStoneCount,coords);moveStones(newState.board,movingStones,dropCounts,coords,direction)}if(state.activeColor===BLACK){newState.moveNumber++}newState.activeColor=invertColor(newState.activeColor);return newState}function liftStones(board,n,coords){lodash.update(board,coords,function(stones){return lodash.dropRight(stones,n)})}function moveStones(board,stones,dropCounts,fromCoords,direction){if(!lodash.isEmpty(dropCounts)){(function(){var dropCount=lodash.first(dropCounts);var droppedStones=lodash.take(stones,dropCount);var toCoords=getNextCoords(fromCoords,direction);lodash.update(board,toCoords,function(existingStones){return[].concat(babelHelpers.toConsumableArray(existingStones),babelHelpers.toConsumableArray(droppedStones))});moveStones(board,lodash.drop(stones,dropCount),lodash.drop(dropCounts),toCoords,direction)})()}}function getDropCounts(ptnMove){return(ptnMove.match(/[<>+-](\d*)/)[1]||"1").split("").map(Number)}function getPlacedColor(state){if(state.moveNumber===1){return invertColor(state.activeColor)}return state.activeColor}function invertColor(color){switch(color){case WHITE:return BLACK;case BLACK:return WHITE;default:return null}}function getNextCoords(coords,direction){return lodash.zipWith(coords,direction,function(a,b){return a+b})}function isPlacement(ptnMove){return!isMovement(ptnMove)}function isMovement(ptnMove){return/[<>+-]/.test(ptnMove)}var NORTH=[1,0];var SOUTH=[-1,0];var WEST=[0,-1];var EAST=[0,1];function getMovementDirection(ptnMove){var direction=ptnMove.match(/[<>+-]/)[0];switch(direction){case"+":return NORTH;case"-":return SOUTH;case"<":return WEST;case">":return EAST;default:return[0,0]}}function tpsToJson(tps){var matches=tps.match(/\[TPS "(.*) (\d) (\d+)"\]/i);if(!matches){throw new Error(tps+" is not a valid TPS string")}var activeColor=matches[2];var moveNumber=Number(matches[3]);var tpsBoard=matches[1];var board=boardFromTps(tpsBoard);return{activeColor:activeColor,moveNumber:moveNumber,board:board}}function boardFromTps(tpsBoard){var tpsRanks=tpsBoard.split("/").reverse();return lodash.map(tpsRanks,rankFromTps)}function rankFromTps(tpsRank){var tpsSquares=tpsRank.split(",");return lodash.flatMap(tpsSquares,squaresFromTps)}function squaresFromTps(tpsSquares){var empty=tpsSquares.match(/x(\d)?/);if(empty){var numberOfSquares=empty[1]||1;return lodash.times(numberOfSquares,function(){return[]})}return[tpsSquares.match(/\d\D?/g)]}function jsonToTps(state){var tpsBoard=tpsFromBoard(state.board);tpsBoard=tpsBoard.replace(/x(,x)+/g,function(match){return"x"+Math.ceil(match.length/2)});return'[TPS "'+tpsBoard+" "+state.activeColor+" "+state.moveNumber+'"]'}function tpsFromBoard(board){return lodash.map(board,tpsFromRank).reverse().join("/")}function tpsFromRank(rank){return lodash.map(rank,tpsFromSquare).join(",")}function tpsFromSquare(square){return lodash.isEmpty(square)?"x":square.join("")}function getTps(tps,moves){var state=getState(tpsToJson(tps),moves);return jsonToTps(state)}exports.getTps=getTps;exports.getState=getState;exports.jsonToTps=jsonToTps;exports.tpsToJson=tpsToJson;exports.getInitialState=getInitialState});
